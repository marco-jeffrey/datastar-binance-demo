<!DOCTYPE html>
<html lang="en" class="bg-gray-900 text-white">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ symbol }} Live Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module" src="https://cdn.jsdelivr.net/gh/starfederation/datastar@1.0.0-RC.6/bundles/datastar.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'up': '#10b981',
                        'down': '#ef4444'
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Monaco', 'Consolas', monospace; }
        .price-flash { animation: priceFlash 0.5s ease; }
        @keyframes priceFlash {
            0% { background-color: transparent; }
            50% { background-color: rgba(16, 185, 129, 0.2); }
            100% { background-color: transparent; }
        }
        .trade-item { transition: background-color 0.15s ease; }
    </style>
</head>
<body class="p-4 max-w-7xl mx-auto">

<!-- Header: Current Price -->
<div class="bg-gray-800 rounded-lg p-6 mb-4 border border-gray-700">
    <div class="flex justify-between items-start">
        <div>
            <div class="text-gray-400 text-sm uppercase tracking-wide">{{ symbol }}</div>
            <div id="current-price" class="text-5xl font-bold">
                {% if latest_ticker %}
                    ${{ "%.2f"|format(latest_ticker.c|float) }}
                {% else %}
                    $0.00
                {% endif %}
            </div>
        </div>
        <div class="text-right">
            <div id="price-change" class="text-2xl font-semibold 
                {% if latest_ticker and latest_ticker.p|float >= 0 %}text-up{% else %}text-down{% endif %}">
                {% if latest_ticker %}
                    {{ "%+.2f"|format(latest_ticker.p|float) }} ({{ "%+.3f"|format(latest_ticker.P|float) }}%)
                {% else %}
                    +$0.00 (0.000%)
                {% endif %}
            </div>
            <div class="text-gray-400 text-sm mt-1">
                24h High: <span id="high-24h" class="text-green-400">
                    {% if latest_ticker %}${{ "%.2f"|format(latest_ticker.h|float) }}{% else %}--{% endif %}</span>
            </div>
            <div class="text-gray-400 text-sm">
                24h Low: <span id="low-24h" class="text-red-400">
                    {% if latest_ticker %}${{ "%.2f"|format(latest_ticker.l|float) }}{% else %}--{% endif %}</span>
            </div>
        </div>
    </div>
</div>

<!-- Stats Grid -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
    <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
        <div class="text-gray-400 text-xs uppercase">Volume (BTC)</div>
        <div id="volume-btc" class="text-xl font-semibold mt-1">
            {% if latest_ticker %}{{ "%.2f"|format(latest_ticker.v|float) }}{% else %}--{% endif %}
        </div>
    </div>
    
    <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
        <div class="text-gray-400 text-xs uppercase">Volume (USDT)</div>
        <div id="volume-usdt" class="text-xl font-semibold mt-1">
            {% if latest_ticker %}{{ "%.2f"|format((latest_ticker.q|float) / 1e9) }}B{% else %}--{% endif %}
        </div>
    </div>
    
    <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
        <div class="text-gray-400 text-xs uppercase">24h Trades</div>
        <div id="trades-24h" class="text-xl font-semibold mt-1">
            {% if latest_ticker %}{{ "{:,}".format(latest_ticker.n|int) }}{% else %}--{% endif %}
        </div>
    </div>
    
    <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
        <div class="text-gray-400 text-xs uppercase">VWAP</div>
        <div id="vwap" class="text-xl font-semibold mt-1">
            {% if latest_ticker %}${{ "%.2f"|format(latest_ticker.w|float) }}{% else %}--{% endif %}
        </div>
    </div>
</div>

<!-- Trade Feed -->
<div class="bg-gray-800 rounded-lg border border-gray-700 overflow-hidden mb-4">
    <div class="bg-gray-700 px-4 py-2 flex justify-between items-center">
        <h3 class="font-semibold">Live Trades (Last {{ trades|length }})</h3>
        <div class="flex gap-2 text-xs">
            <span class="text-green-400">● Buy</span>
            <span class="text-red-400">● Sell</span>
        </div>
    </div>
    <div id="trade-feed" class="h-96 overflow-y-auto text-sm">
        {% for trade in trades %}
        <div class="trade-item flex justify-between px-4 py-1 border-b border-gray-700 
            {% if loop.index0 == 0 %}bg-gray-700{% endif %}">
            <div>
                <span class="{% if not trade.m %}text-green-400{% else %}text-red-400{% endif %} font-medium">
                    ${{ "%.2f"|format(trade.p|float) }}
                </span>
                <span class="text-gray-500 ml-2">{{ (trade.T // 1000)|timestamp_to_time }}</span>
            </div>
            <div class="text-right">
                <span class="text-white">{{ "%.4f"|format(trade.q|float) }}</span>
                <span class="text-xs {% if not trade.m %}text-green-400{% else %}text-red-400{% endif %} ml-2">
                    {{ 'BUY' if not trade.m else 'SELL' }}
                </span>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Order Book -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
    <div class="bg-gray-800 rounded-lg border border-gray-700 overflow-hidden">
        <div class="bg-green-900 bg-opacity-20 px-4 py-2 text-green-400 font-semibold">BIDS</div>
        <div id="bids" class="p-2 text-sm">
            {% if latest_ticker %}
            <div class="flex justify-between items-center py-1">
                <span class="text-green-400">${{ "%.2f"|format(latest_ticker.b|float) }}</span>
                <span class="text-gray-300">{{ "%.4f"|format(latest_ticker.B|float) }}</span>
            </div>
            {% endif %}
        </div>
    </div>
    
    <div class="bg-gray-800 rounded-lg border border-gray-700 overflow-hidden">
        <div class="bg-red-900 bg-opacity-20 px-4 py-2 text-red-400 font-semibold">ASKS</div>
        <div id="asks" class="p-2 text-sm">
            {% if latest_ticker %}
            <div class="flex justify-between items-center py-1">
                <span class="text-red-400">${{ "%.2f"|format(latest_ticker.a|float) }}</span>
                <span class="text-gray-300">{{ "%.4f"|format(latest_ticker.A|float) }}</span>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Sparkline Chart -->
<div class="bg-gray-800 rounded-lg border border-gray-700 p-4">
    <h3 class="font-semibold mb-3">Price Trend (Last 60s)</h3>
    <svg id="sparkline" width="100%" height="120" class="overflow-visible">
        <!-- Initial sparkline from template -->
        {% if tickers %}
        <defs>
            <linearGradient id="spark-gradient" x1="0%" y1="0%" x2="0%" y2="100%">
                <stop offset="0%" style="stop-color:#10b981;stop-opacity:0.4" />
                <stop offset="100%" style="stop-color:#10b981;stop-opacity:0" />
            </linearGradient>
        </defs>
        <polyline 
            points="{% for ticker in tickers|reverse %}{{ loop.index0 * 20 }},{{ 120 - (ticker.c|float / 1000) }}{% if not loop.last %} {% endif %}{% endfor %}"
            fill="none" stroke="#10b981" stroke-width="2"/>
        {% endif %}
    </svg>
</div>

<!-- Status Bar -->
<div class="fixed bottom-4 left-4 bg-gray-800 px-3 py-2 rounded-full border border-gray-700 flex items-center gap-2">
    <div id="status-dot" class="w-3 h-3 bg-yellow-500 rounded-full"></div>
    <span id="status-text" class="text-xs text-gray-400">Connecting...</span>
    <span id="last-update" class="text-xs text-gray-500"></span>
</div>

<!-- Jinja2 Custom Filter for Timestamp -->
<script>
    // This is the ONLY JavaScript needed for live updates
    const eventSource = new EventSource('/stream');
    const statusDot = document.getElementById('status-dot');
    const statusText = document.getElementById('status-text');
    const lastUpdate = document.getElementById('last-update');
    
    // Connection opened
    eventSource.addEventListener('open', () => {
        statusDot.className = 'w-3 h-3 bg-green-500 rounded-full animate-pulse';
        statusText.textContent = 'Live';
    });
    
    // Handle messages
    eventSource.addEventListener('message', (event) => {
        const data = JSON.parse(event.data);
        lastUpdate.textContent = new Date().toLocaleTimeString();
        
        if (data.e === 'trade') {
            // Update trade feed
            const feed = document.getElementById('trade-feed');
            const isBuy = !data.m;
            const row = document.createElement('div');
            row.className = `trade-item flex justify-between px-4 py-1 border-b border-gray-700 bg-gray-700 price-flash`;
            row.innerHTML = `
                <div>
                    <span class="${isBuy ? 'text-green-400' : 'text-red-400'} font-medium">
                        $${parseFloat(data.p).toFixed(2)}
                    </span>
                    <span class="text-gray-500 ml-2">${new Date(data.T).toLocaleTimeString()}</span>
                </div>
                <div class="text-right">
                    <span class="text-white">${parseFloat(data.q).toFixed(4)}</span>
                    <span class="text-xs ${isBuy ? 'text-green-400' : 'text-red-400'} ml-2">
                        ${isBuy ? 'BUY' : 'SELL'}
                    </span>
                </div>
            `;
            feed.insertBefore(row, feed.firstChild);
            
            // Keep only 20 rows
            while (feed.children.length > 20) {
                feed.removeChild(feed.lastChild);
            }
            
            // Remove flash after animation
            setTimeout(() => row.classList.remove('bg-gray-700', 'price-flash'), 500);
            
        } else if (data.e === '24hrTicker') {
            // Update all ticker-based elements
            const colorClass = parseFloat(data.p) >= 0 ? 'text-up' : 'text-down';
            
            // Price and change
            document.getElementById('current-price').textContent = 
                `$${parseFloat(data.c).toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            document.getElementById('price-change').innerHTML = 
                `<span class="${colorClass}">${parseFloat(data.p) >= 0 ? '+' : ''}$${parseFloat(data.p).toFixed(2)} (${parseFloat(data.P)}%)</span>`;
            
            // Stats
            document.getElementById('volume-btc').textContent = 
                (parseFloat(data.v)).toLocaleString('en-US', {maximumFractionDigits: 2});
            document.getElementById('volume-usdt').textContent = 
                (parseFloat(data.q) / 1e9).toFixed(2) + 'B';
            document.getElementById('trades-24h').textContent = 
                parseInt(data.n).toLocaleString();
            document.getElementById('vwap').textContent = 
                `$${parseFloat(data.w).toFixed(2)}`;
            
            // Order book
            document.querySelector('#bids .flex span:first-child').textContent = 
                `$${parseFloat(data.b).toFixed(2)}`;
            document.querySelector('#bids .flex span:last-child').textContent = 
                parseFloat(data.B).toFixed(4);
            document.querySelector('#asks .flex span:first-child').textContent = 
                `$${parseFloat(data.a).toFixed(2)}`;
            document.querySelector('#asks .flex span:last-child').textContent = 
                parseFloat(data.A).toFixed(4);
            
            // Update high/low
            document.getElementById('high-24h').textContent = `$${parseFloat(data.h).toLocaleString()}`;
            document.getElementById('low-24h').textContent = `$${parseFloat(data.l).toLocaleString()}`;
        }
    });
    
    // Connection error
    eventSource.addEventListener('error', () => {
        statusDot.className = 'w-3 h-3 bg-red-500 rounded-full';
        statusText.textContent = 'Disconnected';
    });
</script>

</body>
</html>